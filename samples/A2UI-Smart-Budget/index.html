<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <title>A2UI Smart Budget</title>
    <!-- Add Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #28a745; /* Green for finance */
        --bg-color: #f4f6f8;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #status-bar {
        padding: 10px 20px;
        background: white;
        border-bottom: 1px solid #ddd;
        font-size: 12px;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #ui-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      #input-area {
        padding: 15px;
        background: white;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: center;
      }
      #input-area-inner {
        max-width: 600px;
        width: 100%;
        display: flex;
        gap: 10px;
      }
      input {
        flex: 1;
        padding: 12px 15px;
        border-radius: 20px;
        border: 1px solid #ddd;
        font-size: 16px;
        outline: none;
        transition: border 0.2s;
      }
      input:focus {
        border-color: var(--primary-color);
      }
      button#send-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
      }
      button:disabled {
        background: #ccc;
      }

      /* A2UI Styles */
      .a2ui-surface {
        animation: fadeIn 0.4s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .a2ui-column {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }
      .a2ui-row {
        display: flex;
        flex-direction: row;
        gap: 10px;
        width: 100%;
        align-items: center;
        justify-content: space-between;
      }

      .a2ui-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 20px;
        border: 1px solid #eee;
      }

      .a2ui-text {
        margin: 0;
        color: #333;
      }
      .a2ui-text-h1 {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 10px;
      }
      .a2ui-text-h2 {
        font-size: 18px;
        font-weight: 700;
        margin-top: 10px;
        margin-bottom: 5px;
      }
      .a2ui-text-caption {
        font-size: 12px;
        color: #888;
        text-align: center;
        margin-top: 5px;
      }

      .a2ui-button {
        width: 100%;
        padding: 12px;
        background: #eee;
        color: #333;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        text-align: center;
      }
      .a2ui-button-primary {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
      }
      .a2ui-button-primary:hover {
        filter: brightness(0.95);
      }

      /* Chart Container */
      .a2ui-chart-container {
        position: relative;
        height: 250px;
        width: 100%;
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div id="status-bar">
      <span>A2UI Budget Agent</span>
      <span
        id="loading-indicator"
        style="display: none; color: var(--primary-color); font-weight: bold"
        >Processing...</span
      >
    </div>

    <div id="ui-container">
      <div style="text-align: center; color: #999; margin-top: 60px">
        <h3>Budget Simulator</h3>
        <p>
          Try: "Check this month's budget" or<br />"Reduce Dining Out by 5000
          and save it"
        </p>
      </div>
    </div>

    <div id="input-area">
      <div id="input-area-inner">
        <input
          type="text"
          id="user-input"
          placeholder="Ask about your budget..."
          onkeydown="if(event.key==='Enter') handleSend()"
        />
        <button id="send-btn" onclick="handleSend()">Send</button>
      </div>
    </div>

    <script>
      let appState = { surfaces: {}, activeSurfaceId: null };

      let activeCharts = {};

      function renderA2UiMessages(messages) {
        messages.forEach((msg) => {
          const surfaceId =
            msg.surfaceUpdate?.surfaceId ||
            msg.dataModelUpdate?.surfaceId ||
            msg.beginRendering?.surfaceId ||
            "default";
          appState.activeSurfaceId = surfaceId;

          if (!appState.surfaces[surfaceId]) {
            appState.surfaces[surfaceId] = {
              data: {},
              components: {},
              rootId: null,
            };
          }
          const state = appState.surfaces[surfaceId];

          if (msg.beginRendering) {
            state.rootId = msg.beginRendering.root;
            if (msg.beginRendering.styles?.primaryColor) {
              document.documentElement.style.setProperty(
                "--primary-color",
                msg.beginRendering.styles.primaryColor
              );
            }
          }
          if (msg.dataModelUpdate && msg.dataModelUpdate.contents) {
            msg.dataModelUpdate.contents.forEach((entry) => {
              state.data[entry.key] = parseValue(entry);
            });
          }
          if (msg.surfaceUpdate) {
            msg.surfaceUpdate.components.forEach(
              (c) => (state.components[c.id] = c)
            );
            if (!state.rootId && msg.surfaceUpdate.components.length > 0)
              state.rootId = msg.surfaceUpdate.components[0].id;
          }
        });
        renderAppState();
      }

      function renderAppState() {
        const container = document.getElementById("ui-container");
        container.innerHTML = "";

        const sid = appState.activeSurfaceId;
        if (!sid) return;

        const s = appState.surfaces[sid];
        if (s && s.rootId) {
          const el = renderComponent(sid, s.rootId, "");
          if (el) {
            const surfaceDiv = document.createElement("div");
            surfaceDiv.className = "a2ui-surface";
            surfaceDiv.appendChild(el);
            container.appendChild(surfaceDiv);
          }
        }
      }

      function parseValue(entry) {
        if (!entry || typeof entry !== "object") return null;
        if (entry.valueString !== undefined) return entry.valueString;
        if (entry.valueNumber !== undefined) return entry.valueNumber;
        if (entry.valueMap) {
          const isList = entry.valueMap.every((v, i) => v.key === String(i));
          if (isList) return entry.valueMap.map((v) => parseValue(v)); // Return simple array
          const obj = {};
          entry.valueMap.forEach((v) => {
            if (v.key) obj[v.key] = parseValue(v);
          });
          return obj;
        }
        return null;
      }

      function resolvePath(sid, path) {
        if (!path) return null;
        const p = path.startsWith("/") ? path.substring(1) : path;
        const parts = p.split("/");
        let cur = appState.surfaces[sid].data;
        for (const part of parts) {
          if (cur == null) return null;
          if (Array.isArray(cur) && !isNaN(parseInt(part)))
            cur = cur[parseInt(part)];
          else cur = cur[part];
        }
        return cur;
      }

      function renderComponent(sid, cid, ctx) {
        const s = appState.surfaces[sid];
        const def = s.components[cid];
        if (!def) return null;
        const type = Object.keys(def.component)[0];
        const props = def.component[type];
        const el = document.createElement("div");
        if (def.weight) el.style.flex = def.weight;

        try {
          switch (type) {
            case "Column":
              el.className = "a2ui-column";
              if (props.children) renderChildren(sid, props.children, el, ctx);
              break;
            case "Row":
              el.className = "a2ui-row";
              if (props.children) renderChildren(sid, props.children, el, ctx);
              break;
            case "List":
              el.className = "a2ui-column";
              if (props.children) renderChildren(sid, props.children, el, ctx);
              break;
            case "Card":
              el.className = "a2ui-card";
              if (props.child) {
                const c = renderComponent(sid, props.child, ctx);
                if (c) el.appendChild(c);
              }
              break;
            case "Text":
              const h = props.usageHint || "body";
              el.className = `a2ui-text a2ui-text-${h}`;
              let txt =
                props.text.literalString || resolvePath(sid, props.text.path);
              el.innerText = txt || "";
              break;

            // --- NEW CHART COMPONENT ---
            case "Chart":
              el.className = "a2ui-chart-container";
              const canvas = document.createElement("canvas");
              el.appendChild(canvas);

              const labels = resolvePath(sid, props.labels.path) || [];
              const dataPoints = resolvePath(sid, props.data.path) || [];
              const chartType = props.type || "pie";

              setTimeout(() => {
                if (activeCharts[cid]) activeCharts[cid].destroy();
                activeCharts[cid] = new Chart(canvas, {
                  type: chartType,
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        data: dataPoints,
                        backgroundColor: [
                          "#28a745",
                          "#ffc107",
                          "#17a2b8",
                          "#dc3545",
                          "#6c757d",
                        ],
                        borderWidth: 1,
                      },
                    ],
                  },
                  options: { responsive: true, maintainAspectRatio: false },
                });
              }, 0);
              break;

            case "Button":
              const btn = document.createElement("button");
              btn.className = "a2ui-button";
              if (props.primary) btn.classList.add("a2ui-button-primary");
              if (props.child) {
                const lbl = renderComponent(sid, props.child, ctx);
                if (lbl) btn.innerText = lbl.innerText;
              }
              btn.onclick = () => {
                if (
                  props.action &&
                  props.action.name === "update_budget_sheet"
                ) {
                  const c = props.action.context || [];
                  const payload = {};
                  c.forEach((item) => {
                    payload[item.key] =
                      item.value.literalString ||
                      resolvePath(sid, item.value.path);
                  });
                  sendMessage(
                    JSON.stringify(payload),
                    "update_budget_sheet",
                    "Updating Sheet..."
                  );
                }
              };
              el.appendChild(btn);
              break;
          }
        } catch (e) {
          console.error(e);
        }
        return el;
      }

      function renderChildren(sid, ch, el, ctx) {
        if (ch.explicitList) {
          ch.explicitList.forEach((id) => {
            const c = renderComponent(sid, id, ctx);
            if (c) el.appendChild(c);
          });
        }
        if (ch.template) {
          const listData = resolvePath(sid, ch.template.dataBinding);
          if (listData && Array.isArray(listData)) {
            listData.forEach((_, i) => {
              const c = renderComponent(
                sid,
                ch.template.componentId,
                `${ch.template.dataBinding}/${i}`
              );
              if (c) el.appendChild(c);
            });
          }
        }
      }

      function handleSend() {
        const i = document.getElementById("user-input");
        const txt = i.value;
        if (!txt) return;
        i.value = "";
        sendMessage(txt, null, "Thinking...");
      }

      function sendMessage(query, toolName, statusMsg) {
        const indicator = document.getElementById("loading-indicator");
        const stText = document.querySelector("#status-bar span");
        indicator.style.display = "inline";
        stText.innerText = statusMsg;

        let finalQuery = query;
        if (toolName === "update_budget_sheet") {
          const payload = JSON.parse(query);
          finalQuery = `Execute update_budget_sheet with these details: ${JSON.stringify(
            payload
          )}`;
        }

        google.script.run
          .withSuccessHandler((r) => {
            indicator.style.display = "none";
            stText.innerText = "Ready";
            if (r.uiJson) renderA2UiMessages(r.uiJson);
            else if (r.text) {
              document.getElementById(
                "ui-container"
              ).innerHTML = `<div class="a2ui-card"><p>${r.text}</p></div>`;
            }
          })
          .withFailureHandler((e) => {
            alert("Error: " + e.message);
            indicator.style.display = "none";
          })
          .processUserRequest(finalQuery);
      }
    </script>
  </body>
</html>
